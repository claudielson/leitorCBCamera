<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Leitor de C√≥digo de Barras (API Nativa)</title>
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: white;
            text-align: center;
        }
        
        h2 {
            margin: 10px 0 16px;
            font-size: 20px;
        }
        
        #video-container {
            position: relative;
            width: 100%;
            max-width: 380px;
            height: 300px;
            margin: 0 auto 20px;
            overflow: hidden;
            border-radius: 12px;
            background: #000;
            border: 2px solid #333;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #video-container::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 240px;
            height: 120px;
            border: 2px solid rgba(76, 175, 80, 0.8);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        #result {
            min-height: 32px;
            margin: 16px 0;
            font-size: 18px;
            color: #4CAF50;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
        }
        
        .btn {
            padding: 10px 16px;
            margin: 5px;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            background: #333;
            color: white;
            cursor: pointer;
        }
        
        .btn.success {
            background: #4CAF50;
        }
        
        .btn.danger {
            background: #f44336;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h2>Leitor de C√≥digo de Produto</h2>
    <p>Chrome Android 83+ e Microsoft Edge</p>
    <p>EAN-13 ‚Ä¢ UPC-A ‚Ä¢ API Nativa do Navegador</p>

    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
    </div>

    <div id="result">Aponte o c√≥digo dentro da moldura</div>

    <button id="startBtn" class="btn success">Iniciar Leitura</button>
    <button id="stopBtn" class="btn danger hidden">Parar</button>

    <script>
        let stream = null;
        let detectionInterval = null;
        const video = document.getElementById('video');
        const resultDiv = document.getElementById('result');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        // Verifica se o navegador suporta a API
        if (!('BarcodeDetector' in window)) {
            resultDiv.innerHTML = "‚ùå Seu navegador n√£o suporta leitura de c√≥digos.<br>Tente o <b>Chrome mais recente no Android</b>.";
            startBtn.disabled = true;
        }

        async function startScanner() {
            try {
                // ‚úÖ Solicita c√¢mera traseira em alta resolu√ß√£o
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: {
                            ideal: 1920
                        },
                        height: {
                            ideal: 1080
                        },
                        advanced: [{
                            focusMode: "continuous"
                        }, {
                            exposureMode: "continuous"
                        }]
                    }
                });

                video.srcObject = stream;
                await video.play();

                // ‚úÖ Configura o detector para c√≥digos de produto
                const barcodeDetector = new BarcodeDetector({
                    formats: ['ean_13', 'upc_a', 'ean_8', 'upc_e']
                });

                // Fun√ß√£o de detec√ß√£o cont√≠nua
                const detect = async() => {
                    try {
                        const barcodes = await barcodeDetector.detect(video);
                        if (barcodes.length > 0) {
                            const code = barcodes[0].rawValue;
                            const format = barcodes[0].format;

                            // Valida√ß√£o b√°sica
                            if ((format === 'ean_13' && code.length === 13) ||
                                (format === 'upc_a' && code.length === 12)) {
                                resultDiv.innerHTML = `‚úÖ <b>${code}</b><br><small>(${format.toUpperCase()})</small>`;
                                stopScanner(); // Para ap√≥s detectar
                            }
                        }
                    } catch (err) {
                        console.warn("Detec√ß√£o falhou:", err);
                    }
                };

                // Roda a cada 200ms (5x por segundo)
                detectionInterval = setInterval(detect, 200);

                // Atualiza UI
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                resultDiv.innerText = "üîç Aponte o c√≥digo na moldura";

            } catch (err) {
                console.error("Erro na c√¢mera:", err);
                resultDiv.innerHTML = "‚ùå Erro ao acessar a c√¢mera.<br>Permiss√µes negadas ou n√£o suportado.";
            }
        }

        function stopScanner() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
        }

        startBtn.addEventListener('click', startScanner);
        stopBtn.addEventListener('click', stopScanner);
    </script>
</body>

</html>